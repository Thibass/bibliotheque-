<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma Biblioth√®que</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            padding: 20px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .shelf-container {
            margin-bottom: 80px;
        }

        .shelf-label {
            color: #999;
            font-size: 18px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shelf-label-text {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .shelf-label-text:hover {
            background: rgba(100, 100, 100, 0.3);
        }

        .shelf-menu {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s ease;
            font-size: 16px;
            opacity: 0.6;
        }

        .shelf-menu:hover {
            background: rgba(100, 100, 100, 0.3);
            opacity: 1;
        }

        .add-shelf-btn {
            margin: 20px 0;
            padding: 15px;
            border: 2px dashed #666;
            background: rgba(100, 100, 100, 0.2);
            color: #888;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-size: 18px;
        }

        .add-shelf-btn:hover {
            border-color: #999;
            background: rgba(100, 100, 100, 0.3);
            color: #aaa;
        }

        .shelf {
            position: relative;
            min-height: 180px;
            margin-bottom: 20px;
        }

        .books {
            display: flex;
            gap: 8px;
            padding: 0 20px 35px 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .book {
            width: 45px;
            height: 150px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease, filter 0.2s ease;
            image-rendering: pixelated;
            flex-shrink: 0;
        }

        .book.small {
            width: 35px;
            height: 120px;
        }

        .book.large {
            width: 55px;
            height: 180px;
        }

        .book:hover {
            transform: translateY(-10px);
            filter: brightness(1.2);
        }

        .book:active {
            transform: translateY(-5px);
        }

        .book canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        .shelf-board {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25px;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 3px solid #0a0a0a;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5), inset 0 2px 0 #3a3a3a;
        }

        .shelf-board::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 10px;
            right: 10px;
            height: 2px;
            background: #0a0a0a;
            opacity: 0.5;
        }

        .book-menu {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 3px;
        }

        .book:hover .book-menu {
            opacity: 1;
        }

        .book-menu:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .book-menu::before {
            content: '‚ãØ';
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }

        .book-resize {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 3px;
            font-size: 12px;
        }

        .book:hover .book-resize {
            opacity: 1;
        }

        .book-resize:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .add-book-btn {
            width: 45px;
            height: 150px;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s ease, filter 0.2s ease;
            flex-shrink: 0;
            border: 2px dashed #666;
            background: rgba(100, 100, 100, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #888;
            border-radius: 3px;
        }

        .add-book-btn:hover {
            transform: translateY(-10px);
            border-color: #999;
            background: rgba(100, 100, 100, 0.3);
            color: #aaa;
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: #1a1a1a;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            border: 2px solid #666;
            z-index: 10;
        }

        .book:hover .tooltip {
            opacity: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            border: 3px solid #1a1a1a;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            color: #ccc;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #999;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 2px solid #3a3a3a;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-radius: 4px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #666;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #555;
            color: #fff;
        }

        .btn-primary:hover {
            background: #666;
        }

        .btn-danger {
            background: #5a3a3a;
            color: #fff;
        }

        .btn-danger:hover {
            background: #6a4a4a;
        }

        .btn-secondary {
            background: #3a3a3a;
            color: #ccc;
        }

        .btn-secondary:hover {
            background: #4a4a4a;
        }

        .data-management {
            background: rgba(50, 50, 50, 0.3);
            border: 2px solid #555;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .data-management h3 {
            color: #aaa;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .data-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .btn-export {
            background: #4a5a4a;
            color: #fff;
        }

        .btn-export:hover {
            background: #5a6a5a;
        }

        .btn-import {
            background: #5a5a4a;
            color: #fff;
        }

        .btn-import:hover {
            background: #6a6a5a;
        }

        .btn-reset {
            background: #5a4a4a;
            color: #fff;
        }

        .btn-reset:hover {
            background: #6a5a5a;
        }

        .help-text {
            background: rgba(50, 50, 50, 0.3);
            border: 2px solid #555;
            border-radius: 8px;
            padding: 20px;
            margin-top: 40px;
            color: #999;
            line-height: 1.8;
        }

        .help-text h2 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="library"></div>

        <div class="add-shelf-btn" onclick="openAddShelfModal()">
            + Ajouter une √©tag√®re
        </div>

        <!-- Modal pour ajouter/√©diter un livre -->
        <div id="bookModal" class="modal">
            <div class="modal-content">
                <h2 id="modalTitle">Ajouter un livre</h2>
                <form id="bookForm">
                    <div class="form-group">
                        <label for="bookTitle">Titre</label>
                        <input type="text" id="bookTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="bookUrl">URL</label>
                        <input type="url" id="bookUrl" required placeholder="https://notion.so/...">
                    </div>
                    <div class="form-group">
                        <label for="bookColor">Couleur</label>
                        <input type="color" id="bookColor" value="#6a7a7a">
                    </div>
                    <div class="form-group">
                        <label for="bookCategory">Cat√©gorie</label>
                        <input type="text" id="bookCategory" value="G√©n√©ral">
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-danger" id="deleteBtn" style="display: none;">Supprimer</button>
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal pour ajouter/√©diter une √©tag√®re -->
        <div id="shelfModal" class="modal">
            <div class="modal-content">
                <h2 id="shelfModalTitle">Ajouter une √©tag√®re</h2>
                <form id="shelfForm">
                    <div class="form-group">
                        <label for="shelfName">Nom de l'√©tag√®re</label>
                        <input type="text" id="shelfName" required>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-danger" id="deleteShelfBtn" style="display: none;">Supprimer l'√©tag√®re</button>
                        <button type="button" class="btn btn-secondary" id="cancelShelfBtn">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal d'aide -->
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <h2>üí° Guide d'utilisation</h2>
                <div style="line-height: 1.8; color: #ccc;">
                    <h3 style="margin-top: 20px; color: #d4af37; font-size: 16px;">üìö G√©rer les livres</h3>
                    <p>‚Ä¢ Cliquez sur <strong>+</strong> √† c√¥t√© des livres pour en ajouter un nouveau</p>
                    <p>‚Ä¢ Survolez un livre et cliquez sur <strong>‚ãØ</strong> en haut pour le modifier/supprimer</p>
                    <p>‚Ä¢ Cliquez sur <strong>‚Üî</strong> en bas pour changer sa taille (petit ‚Üí moyen ‚Üí grand)</p>
                    <p>‚Ä¢ Cliquez sur un livre pour ouvrir son lien dans un nouvel onglet</p>

                    <h3 style="margin-top: 20px; color: #d4af37; font-size: 16px;">üìñ G√©rer les √©tag√®res</h3>
                    <p>‚Ä¢ Cliquez sur le nom d'une √©tag√®re ou <strong>‚ãØ</strong> pour la renommer/supprimer</p>
                    <p>‚Ä¢ Cliquez sur <strong>+ Ajouter une √©tag√®re</strong> pour cr√©er une cat√©gorie</p>
                    <p>‚Ä¢ Supprimer une √©tag√®re supprime tous ses livres</p>

                    <h3 style="margin-top: 20px; color: #d4af37; font-size: 16px;">üíæ Gestion des donn√©es</h3>
                    <p>‚Ä¢ <strong>Mode actuel</strong> : <span id="currentMode" style="color: #7a9a7a;">Local (navigateur)</span></p>
                    <p>‚Ä¢ <strong>Exporter JSON</strong> : T√©l√©charge une sauvegarde de vos donn√©es</p>
                    <p>‚Ä¢ <strong>Importer JSON</strong> : Restaure des donn√©es depuis un fichier</p>
                    <p>‚Ä¢ <strong>R√©initialiser</strong> : Retour √† la configuration par d√©faut</p>
                    <p style="margin-top: 10px; font-size: 12px; color: #888;">
                        üí° Astuce : Exportez r√©guli√®rement vos donn√©es pour √©viter de les perdre
                    </p>

                    <h3 style="margin-top: 20px; color: #d4af37; font-size: 16px;">üîó Connexion Notion (optionnel)</h3>
                    <p>‚Ä¢ Vous pouvez synchroniser vos donn√©es avec une database Notion</p>
                    <p>‚Ä¢ Cliquez sur <strong>‚öôÔ∏è Configurer Notion</strong> ci-dessous</p>
                    <p>‚Ä¢ N√©cessite une int√©gration Notion et une database</p>
                    <p style="margin-top: 10px; font-size: 12px; color: #888;">
                        ‚ö†Ô∏è Sans configuration Notion, vos donn√©es restent dans le navigateur
                    </p>

                    <h3 style="margin-top: 20px; color: #d4af37; font-size: 16px;">‚ú® Livre dor√©</h3>
                    <p>‚Ä¢ Ce livre d'aide appara√Æt toujours en premier</p>
                    <p>‚Ä¢ Il ne peut pas √™tre modifi√© ni supprim√©</p>
                    <p>‚Ä¢ Cliquez dessus pour rouvrir ce guide</p>
                </div>
                <div class="modal-buttons" style="margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="openNotionConfig()">‚öôÔ∏è Configurer Notion</button>
                    <button type="button" class="btn btn-primary" onclick="closeHelpModal()">Compris !</button>
                </div>
            </div>
        </div>

        <!-- Modal de configuration Notion -->
        <div id="notionConfigModal" class="modal">
            <div class="modal-content" style="max-width: 700px;">
                <h2>‚öôÔ∏è Configuration Notion</h2>
                <div style="line-height: 1.6; color: #ccc; font-size: 13px;">
                    
                    <div style="background: rgba(122, 154, 122, 0.2); padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #7a9a7a;">
                        <strong style="color: #7a9a7a;">‚ÑπÔ∏è Fonctionnement</strong><br>
                        Une fois configur√©, vos livres seront sauvegard√©s dans une database Notion. Vous pourrez les √©diter depuis cette interface ou directement dans Notion !
                    </div>

                    <h3 style="color: #d4af37; margin-top: 20px; margin-bottom: 10px;">üìù √âtape 1 : Cr√©er une int√©gration</h3>
                    <ol style="margin-left: 20px; line-height: 2;">
                        <li>Allez sur <a href="https://www.notion.so/my-integrations" target="_blank" style="color: #7a9a9a;">notion.so/my-integrations</a></li>
                        <li>Cliquez sur <strong>"+ New integration"</strong></li>
                        <li>Donnez un nom (ex: "Ma Biblioth√®que")</li>
                        <li>Activez les permissions : <strong>Read, Update, Insert content</strong></li>
                        <li>Copiez le <strong>Internal Integration Token</strong></li>
                    </ol>

                    <div class="form-group" style="margin-top: 15px;">
                        <label for="notionToken">üîë Integration Token</label>
                        <input type="password" id="notionToken" placeholder="secret_..." style="font-size: 12px;">
                        <div style="font-size: 11px; color: #888; margin-top: 5px;">
                            Format : secret_XXXXXXXXXXXXXXXXXXXXXXXX
                        </div>
                    </div>

                    <h3 style="color: #d4af37; margin-top: 25px; margin-bottom: 10px;">üìä √âtape 2 : Cr√©er la database</h3>
                    <ol style="margin-left: 20px; line-height: 2;">
                        <li>Dans Notion, cr√©ez une page avec une <strong>Table database</strong></li>
                        <li>Configurez exactement ces colonnes :
                            <ul style="margin-left: 20px; margin-top: 5px; font-size: 12px;">
                                <li><strong>Titre</strong> ‚Üí Type: Title</li>
                                <li><strong>URL</strong> ‚Üí Type: URL</li>
                                <li><strong>Couleur</strong> ‚Üí Type: Text</li>
                                <li><strong>Cat√©gorie</strong> ‚Üí Type: Select</li>
                                <li><strong>Taille</strong> ‚Üí Type: Select (options: small, medium, large)</li>
                            </ul>
                        </li>
                        <li>Cliquez sur <strong>‚ãØ</strong> ‚Üí <strong>Connections</strong> ‚Üí Ajoutez votre int√©gration</li>
                        <li>Copiez l'ID de la database depuis l'URL</li>
                    </ol>

                    <div class="form-group" style="margin-top: 15px;">
                        <label for="databaseId">üóÑÔ∏è Database ID</label>
                        <input type="text" id="databaseId" placeholder="abc123def456..." style="font-size: 12px;">
                        <div style="font-size: 11px; color: #888; margin-top: 5px;">
                            Dans l'URL : notion.so/workspace/<strong>[DATABASE_ID]</strong>?v=...
                        </div>
                    </div>

                    <div id="notionStatus" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>

                    <div style="background: rgba(90, 74, 74, 0.2); padding: 12px; border-radius: 6px; margin-top: 20px; font-size: 12px; border-left: 4px solid #6a5a5a;">
                        <strong>‚ö†Ô∏è Important :</strong> Ne partagez jamais votre Integration Token publiquement. Il donne acc√®s √† vos donn√©es Notion.
                    </div>
                </div>

                <div class="modal-buttons" style="margin-top: 25px;">
                    <button type="button" class="btn btn-danger" onclick="disconnectNotion()" id="disconnectBtn" style="display: none;">üîå D√©connecter</button>
                    <button type="button" class="btn btn-secondary" onclick="closeNotionConfig()">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="testNotionConnection()">üîå Tester & Connecter</button>
                </div>
            </div>
        </div>

        <div class="data-management">
            <h3>üîß Gestion des donn√©es</h3>
            <div class="data-buttons">
                <button class="btn-small btn-export" onclick="exportData()">üì• Exporter JSON</button>
                <button class="btn-small btn-import" onclick="importData()">üì§ Importer JSON</button>
                <button class="btn-small btn-reset" onclick="resetData()">üîÑ R√©initialiser</button>
            </div>
            <p style="margin-top: 15px; font-size: 12px; color: #777;">
                Exporter : T√©l√©charge vos donn√©es en JSON<br>
                Importer : Charge des donn√©es depuis un fichier JSON<br>
                R√©initialiser : Restaure la configuration par d√©faut
            </p>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION ET STOCKAGE
        // ============================================
        
        // Mode de stockage : 'local' ou 'notion'
        let STORAGE_MODE = localStorage.getItem('storageMode') || 'local';
        let NOTION_TOKEN = localStorage.getItem('notionToken') || '';
        let DATABASE_ID = localStorage.getItem('databaseId') || '';
        
        let BOOKS_CONFIG = [];
        let editingIndex = null;
        let editingShelfName = null;

        // ============================================
        // GESTION DU STOCKAGE
        // ============================================

        // Charger les livres selon le mode
        async function loadBooks() {
            if (STORAGE_MODE === 'notion' && NOTION_TOKEN && DATABASE_ID) {
                await loadBooksFromNotion();
            } else {
                loadBooksFromLocal();
            }
        }

        // Sauvegarder les livres selon le mode
        async function saveBooks() {
            if (STORAGE_MODE === 'notion' && NOTION_TOKEN && DATABASE_ID) {
                // En mode Notion, la sauvegarde est g√©r√©e par les fonctions sp√©cifiques
                return;
            } else {
                saveBooksToLocal();
            }
        }

        // Stockage local
        function loadBooksFromLocal() {
            const saved = localStorage.getItem('libraryBooks');
            if (saved) {
                try {
                    BOOKS_CONFIG = JSON.parse(saved);
                } catch (e) {
                    console.error('Erreur de chargement:', e);
                    BOOKS_CONFIG = getDefaultBooks();
                }
            } else {
                BOOKS_CONFIG = getDefaultBooks();
            }
            generateLibrary();
        }

        function saveBooksToLocal() {
            try {
                localStorage.setItem('libraryBooks', JSON.stringify(BOOKS_CONFIG));
            } catch (e) {
                console.error('Erreur de sauvegarde:', e);
                alert('Erreur lors de la sauvegarde');
            }
        }

        function getDefaultBooks() {
            return [
                {
                    title: "Test",
                    url: "https://notion.so/",
                    color: "#6a7a7a",
                    category: "G√©n√©ral",
                    size: "medium"
                }
            ];
        }

        // ============================================
        // INT√âGRATION NOTION
        // ============================================

        const CORS_PROXY = 'https://corsproxy.io/?';

        async function notionFetch(url, options = {}) {
            const headers = {
                'Authorization': `Bearer ${NOTION_TOKEN}`,
                'Notion-Version': '2022-06-28',
                'Content-Type': 'application/json',
                ...options.headers
            };

            const response = await fetch(CORS_PROXY + encodeURIComponent(url), {
                ...options,
                headers
            });
            return response;
        }

        async function loadBooksFromNotion() {
            const library = document.getElementById('library');
            
            // Afficher un message de chargement sans effacer la biblioth√®que
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(122, 154, 122, 0.9); color: #fff; padding: 10px 20px; border-radius: 6px; z-index: 9999; font-size: 13px;';
            loadingDiv.textContent = 'üîÑ Synchronisation...';
            document.body.appendChild(loadingDiv);

            try {
                const response = await notionFetch(
                    `https://api.notion.com/v1/databases/${DATABASE_ID}/query`,
                    { method: 'POST', body: JSON.stringify({}) }
                );

                if (!response.ok) {
                    throw new Error('Erreur de connexion √† Notion');
                }

                const data = await response.json();
                BOOKS_CONFIG = data.results
                    .filter(page => !page.archived)
                    .map(page => ({
                        pageId: page.id,
                        title: page.properties.Titre?.title[0]?.plain_text || 'Sans titre',
                        url: page.properties.URL?.url || '',
                        color: page.properties.Couleur?.rich_text[0]?.plain_text || '#6a7a7a',
                        category: page.properties.Cat√©gorie?.select?.name || 'G√©n√©ral',
                        size: page.properties.Taille?.select?.name || 'medium'
                    }));

                // Si aucun livre, cr√©er un livre par d√©faut
                if (BOOKS_CONFIG.length === 0) {
                    await createBookInNotion({
                        title: "Test",
                        url: "https://notion.so/",
                        color: "#6a7a7a",
                        category: "G√©n√©ral",
                        size: "medium"
                    });
                    // Recharger apr√®s cr√©ation
                    setTimeout(() => loadBooksFromNotion(), 1000);
                    return;
                }

                generateLibrary();
                updateModeDisplay();
                
                // Notification de succ√®s
                loadingDiv.style.background = 'rgba(122, 154, 122, 0.9)';
                loadingDiv.textContent = '‚úì Synchronis√©';
                setTimeout(() => {
                    loadingDiv.remove();
                }, 2000);
            } catch (error) {
                console.error('Erreur Notion:', error);
                loadingDiv.style.background = 'rgba(154, 122, 122, 0.9)';
                loadingDiv.textContent = '‚ùå Erreur de synchronisation';
                setTimeout(() => {
                    loadingDiv.remove();
                }, 3000);
                
                // Ne pas basculer en mode local, juste afficher l'erreur
                if (BOOKS_CONFIG.length === 0) {
                    BOOKS_CONFIG = getDefaultBooks();
                }
                generateLibrary();
            }
        }

        async function createBookInNotion(bookData) {
            try {
                console.log('Cr√©ation livre dans Notion:', bookData);
                const response = await notionFetch(
                    'https://api.notion.com/v1/pages',
                    {
                        method: 'POST',
                        body: JSON.stringify({
                            parent: { database_id: DATABASE_ID },
                            properties: {
                                'Titre': { title: [{ text: { content: bookData.title } }] },
                                'URL': { url: bookData.url },
                                'Couleur': { rich_text: [{ text: { content: bookData.color } }] },
                                'Cat√©gorie': { select: { name: bookData.category } },
                                'Taille': { select: { name: bookData.size || 'medium' } }
                            }
                        })
                    }
                );

                if (!response.ok) {
                    const error = await response.json();
                    console.error('Erreur API Notion:', error);
                    throw new Error(error.message || 'Erreur de cr√©ation');
                }
                
                const result = await response.json();
                console.log('Livre cr√©√© avec succ√®s:', result);
                
                // Notification de succ√®s
                const notif = document.createElement('div');
                notif.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(122, 154, 122, 0.9); color: #fff; padding: 10px 20px; border-radius: 6px; z-index: 9999; font-size: 13px;';
                notif.textContent = '‚úì Livre ajout√© √† Notion';
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 2000);
                
                return result;
            } catch (error) {
                console.error('Erreur cr√©ation livre:', error);
                alert(`Erreur lors de l'ajout : ${error.message}`);
                return null;
            }
        }

        async function updateBookInNotion(pageId, bookData) {
            try {
                const response = await notionFetch(
                    `https://api.notion.com/v1/pages/${pageId}`,
                    {
                        method: 'PATCH',
                        body: JSON.stringify({
                            properties: {
                                'Titre': { title: [{ text: { content: bookData.title } }] },
                                'URL': { url: bookData.url },
                                'Couleur': { rich_text: [{ text: { content: bookData.color } }] },
                                'Cat√©gorie': { select: { name: bookData.category } },
                                'Taille': { select: { name: bookData.size } }
                            }
                        })
                    }
                );

                if (!response.ok) throw new Error('Erreur de mise √† jour');
                return await response.json();
            } catch (error) {
                alert(`Erreur : ${error.message}`);
                return null;
            }
        }

        async function archiveBookInNotion(pageId) {
            try {
                const response = await notionFetch(
                    `https://api.notion.com/v1/pages/${pageId}`,
                    {
                        method: 'PATCH',
                        body: JSON.stringify({ archived: true })
                    }
                );

                if (!response.ok) throw new Error('Erreur de suppression');
                return await response.json();
            } catch (error) {
                alert(`Erreur : ${error.message}`);
                return null;
            }
        }

        // ============================================
        // INTERFACE UTILISATEUR
        // ============================================

        // Cr√©er une tranche de livre en pixel art
        function createBookSpine(title, color, size = 'medium') {
            const dimensions = {
                small: { width: 35, height: 120, fontSize: 9 },
                medium: { width: 45, height: 150, fontSize: 10 },
                large: { width: 55, height: 180, fontSize: 11 }
            };
            
            const dim = dimensions[size];
            const canvas = document.createElement('canvas');
            canvas.width = dim.width;
            canvas.height = dim.height;
            const ctx = canvas.getContext('2d');

            ctx.fillStyle = color;
            ctx.fillRect(0, 0, dim.width, dim.height);

            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, 3, dim.height);
            ctx.fillRect(dim.width - 3, 0, 3, dim.height);

            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.fillRect(5, 5, 2, dim.height - 10);

            ctx.save();
            ctx.translate(dim.width / 2, dim.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#fff';
            ctx.font = `bold ${dim.fontSize}px "Courier New"`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
            ctx.shadowBlur = 2;
            
            const maxLength = size === 'large' ? 15 : (size === 'small' ? 10 : 12);
            const displayTitle = title.length > maxLength ? title.substring(0, maxLength) + '...' : title;
            ctx.fillText(displayTitle, 0, 0);
            ctx.restore();

            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            ctx.fillRect(10, 10, dim.width - 20, 2);
            ctx.fillRect(10, dim.height - 12, dim.width - 20, 2);

            return canvas;
        }

        function createBook(bookConfig, index) {
            const book = document.createElement('div');
            book.className = 'book';
            if (bookConfig.size) {
                book.classList.add(bookConfig.size);
            }
            
            const canvas = createBookSpine(bookConfig.title, bookConfig.color, bookConfig.size || 'medium');
            book.appendChild(canvas);

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = bookConfig.title;
            book.appendChild(tooltip);

            // Pas de menu pour le livre d'aide
            if (!bookConfig.isHelp) {
                const menu = document.createElement('div');
                menu.className = 'book-menu';
                menu.onclick = (e) => {
                    e.stopPropagation();
                    openEditModal(index);
                };
                book.appendChild(menu);

                const resizeBtn = document.createElement('div');
                resizeBtn.className = 'book-resize';
                resizeBtn.textContent = '‚Üî';
                resizeBtn.onclick = (e) => {
                    e.stopPropagation();
                    toggleBookSize(index);
                };
                book.appendChild(resizeBtn);
            }

            if (bookConfig.isHelp) {
                book.onclick = () => openHelpModal();
            } else {
                book.onclick = () => window.open(bookConfig.url, '_blank');
            }

            return book;
        }

        function toggleBookSize(index) {
            const sizes = ['small', 'medium', 'large'];
            const currentSize = BOOKS_CONFIG[index].size || 'medium';
            const currentIndex = sizes.indexOf(currentSize);
            const nextIndex = (currentIndex + 1) % sizes.length;
            BOOKS_CONFIG[index].size = sizes[nextIndex];
            
            if (STORAGE_MODE === 'notion' && BOOKS_CONFIG[index].pageId) {
                updateBookInNotion(BOOKS_CONFIG[index].pageId, BOOKS_CONFIG[index]).then(() => {
                    setTimeout(() => loadBooksFromNotion(), 1500);
                });
            } else {
                saveBooksToLocal();
                generateLibrary();
            }
        }

        // Auto-refresh en mode Notion toutes les 30 secondes
        let notionRefreshInterval;
        
        function startNotionAutoRefresh() {
            if (notionRefreshInterval) {
                clearInterval(notionRefreshInterval);
            }
            
            if (STORAGE_MODE === 'notion' && NOTION_TOKEN && DATABASE_ID) {
                notionRefreshInterval = setInterval(() => {
                    console.log('Auto-refresh Notion');
                    loadBooksFromNotion();
                }, 30000); // 30 secondes
            }
        }

        function stopNotionAutoRefresh() {
            if (notionRefreshInterval) {
                clearInterval(notionRefreshInterval);
                notionRefreshInterval = null;
            }
        }

        function organizeBooksByCategory(books) {
            const categories = {};
            books.forEach(book => {
                const cat = book.category || 'G√©n√©ral';
                if (!categories[cat]) {
                    categories[cat] = [];
                }
                categories[cat].push(book);
            });
            return categories;
        }

        function generateLibrary() {
            const library = document.getElementById('library');
            library.innerHTML = '';
            const categorizedBooks = organizeBooksByCategory(BOOKS_CONFIG);

            Object.entries(categorizedBooks).forEach(([category, books]) => {
                const shelfContainer = document.createElement('div');
                shelfContainer.className = 'shelf-container';

                const label = document.createElement('div');
                label.className = 'shelf-label';
                
                const labelText = document.createElement('span');
                labelText.className = 'shelf-label-text';
                labelText.textContent = `üìñ ${category}`;
                labelText.onclick = () => openEditShelfModal(category);
                label.appendChild(labelText);

                const shelfMenu = document.createElement('span');
                shelfMenu.className = 'shelf-menu';
                shelfMenu.textContent = '‚ãØ';
                shelfMenu.onclick = () => openEditShelfModal(category);
                label.appendChild(shelfMenu);

                shelfContainer.appendChild(label);

                const shelf = document.createElement('div');
                shelf.className = 'shelf';

                const booksDiv = document.createElement('div');
                booksDiv.className = 'books';

                // Ajouter le livre d'aide au d√©but de la premi√®re √©tag√®re
                if (Object.keys(categorizedBooks)[0] === category) {
                    const helpBook = {
                        title: "üí° Guide",
                        color: "#d4af37",
                        size: "medium",
                        isHelp: true
                    };
                    booksDiv.appendChild(createBook(helpBook, -1));
                }

                books.forEach(bookData => {
                    const index = BOOKS_CONFIG.indexOf(bookData);
                    booksDiv.appendChild(createBook(bookData, index));
                });

                const addBtn = document.createElement('div');
                addBtn.className = 'add-book-btn';
                addBtn.textContent = '+';
                addBtn.onclick = () => openAddModal(category);
                booksDiv.appendChild(addBtn);

                shelf.appendChild(booksDiv);

                const board = document.createElement('div');
                board.className = 'shelf-board';
                shelf.appendChild(board);

                shelfContainer.appendChild(shelf);
                library.appendChild(shelfContainer);
            });
        }

        // Gestion des modals
        const modal = document.getElementById('bookModal');
        const form = document.getElementById('bookForm');
        const modalTitle = document.getElementById('modalTitle');
        const deleteBtn = document.getElementById('deleteBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        function openAddModal(category = 'G√©n√©ral') {
            editingIndex = null;
            modalTitle.textContent = 'Ajouter un livre';
            document.getElementById('bookTitle').value = '';
            document.getElementById('bookUrl').value = '';
            document.getElementById('bookColor').value = '#6a7a7a';
            document.getElementById('bookCategory').value = category;
            deleteBtn.style.display = 'none';
            modal.classList.add('active');
        }

        function openEditModal(index) {
            editingIndex = index;
            const book = BOOKS_CONFIG[index];
            modalTitle.textContent = 'Modifier le livre';
            document.getElementById('bookTitle').value = book.title;
            document.getElementById('bookUrl').value = book.url;
            document.getElementById('bookColor').value = book.color;
            document.getElementById('bookCategory').value = book.category || 'G√©n√©ral';
            deleteBtn.style.display = 'block';
            modal.classList.add('active');
        }

        function closeModal() {
            modal.classList.remove('active');
            editingIndex = null;
        }

        form.onsubmit = async (e) => {
            e.preventDefault();
            const bookData = {
                title: document.getElementById('bookTitle').value,
                url: document.getElementById('bookUrl').value,
                color: document.getElementById('bookColor').value,
                category: document.getElementById('bookCategory').value,
                size: 'medium'
            };

            if (STORAGE_MODE === 'notion') {
                closeModal(); // Fermer imm√©diatement pour meilleur UX
                
                if (editingIndex !== null && BOOKS_CONFIG[editingIndex].pageId) {
                    await updateBookInNotion(BOOKS_CONFIG[editingIndex].pageId, bookData);
                } else {
                    await createBookInNotion(bookData);
                }
                
                // Recharger depuis Notion apr√®s un court d√©lai
                setTimeout(() => loadBooksFromNotion(), 1500);
            } else {
                if (editingIndex !== null) {
                    BOOKS_CONFIG[editingIndex] = bookData;
                } else {
                    BOOKS_CONFIG.push(bookData);
                }
                saveBooksToLocal();
                generateLibrary();
                closeModal();
            }
        };

        deleteBtn.onclick = async () => {
            if (editingIndex !== null && confirm('Voulez-vous vraiment supprimer ce livre ?')) {
                if (STORAGE_MODE === 'notion' && BOOKS_CONFIG[editingIndex].pageId) {
                    closeModal();
                    await archiveBookInNotion(BOOKS_CONFIG[editingIndex].pageId);
                    setTimeout(() => loadBooksFromNotion(), 1500);
                } else {
                    BOOKS_CONFIG.splice(editingIndex, 1);
                    saveBooksToLocal();
                    generateLibrary();
                    closeModal();
                }
            }
        };

        cancelBtn.onclick = closeModal;
        modal.onclick = (e) => {
            if (e.target === modal) closeModal();
        };

        // Gestion des √©tag√®res
        const shelfModal = document.getElementById('shelfModal');
        const shelfForm = document.getElementById('shelfForm');
        const shelfModalTitle = document.getElementById('shelfModalTitle');
        const deleteShelfBtn = document.getElementById('deleteShelfBtn');
        const cancelShelfBtn = document.getElementById('cancelShelfBtn');

        function openAddShelfModal() {
            editingShelfName = null;
            shelfModalTitle.textContent = 'Ajouter une √©tag√®re';
            document.getElementById('shelfName').value = '';
            deleteShelfBtn.style.display = 'none';
            shelfModal.classList.add('active');
        }

        function openEditShelfModal(shelfName) {
            editingShelfName = shelfName;
            shelfModalTitle.textContent = 'Modifier l\'√©tag√®re';
            document.getElementById('shelfName').value = shelfName;
            deleteShelfBtn.style.display = 'block';
            shelfModal.classList.add('active');
        }

        function closeShelfModal() {
            shelfModal.classList.remove('active');
            editingShelfName = null;
        }

        shelfForm.onsubmit = async (e) => {
            e.preventDefault();
            const newName = document.getElementById('shelfName').value;

            if (STORAGE_MODE === 'notion') {
                closeShelfModal(); // Fermer imm√©diatement
                
                if (editingShelfName !== null) {
                    // Renommer l'√©tag√®re
                    const booksToUpdate = BOOKS_CONFIG.filter(b => b.category === editingShelfName);
                    console.log(`Renommage de ${booksToUpdate.length} livres de "${editingShelfName}" vers "${newName}"`);
                    
                    for (const book of booksToUpdate) {
                        await updateBookInNotion(book.pageId, {...book, category: newName});
                    }
                } else {
                    // Cr√©er une nouvelle √©tag√®re avec un livre
                    console.log(`Cr√©ation nouvelle √©tag√®re "${newName}"`);
                    await createBookInNotion({
                        title: 'Nouveau livre',
                        url: 'https://notion.so/',
                        color: '#6a7a7a',
                        category: newName,
                        size: 'medium'
                    });
                }
                
                setTimeout(() => loadBooksFromNotion(), 1500);
            } else {
                if (editingShelfName !== null) {
                    BOOKS_CONFIG.forEach(book => {
                        if (book.category === editingShelfName) {
                            book.category = newName;
                        }
                    });
                } else {
                    BOOKS_CONFIG.push({
                        title: 'Nouveau livre',
                        url: 'https://notion.so/',
                        color: '#6a7a7a',
                        category: newName,
                        size: 'medium'
                    });
                }
                saveBooksToLocal();
                generateLibrary();
                closeShelfModal();
            }
        };

        deleteShelfBtn.onclick = async () => {
            if (editingShelfName !== null && confirm('Voulez-vous vraiment supprimer cette √©tag√®re et tous ses livres ?')) {
                if (STORAGE_MODE === 'notion') {
                    closeShelfModal();
                    const booksToDelete = BOOKS_CONFIG.filter(b => b.category === editingShelfName);
                    console.log(`Suppression de ${booksToDelete.length} livres`);
                    
                    for (const book of booksToDelete) {
                        await archiveBookInNotion(book.pageId);
                    }
                    
                    setTimeout(() => loadBooksFromNotion(), 1500);
                } else {
                    BOOKS_CONFIG = BOOKS_CONFIG.filter(book => book.category !== editingShelfName);
                    saveBooksToLocal();
                    generateLibrary();
                    closeShelfModal();
                }
            }
        };

        cancelShelfBtn.onclick = closeShelfModal;
        shelfModal.onclick = (e) => {
            if (e.target === shelfModal) closeShelfModal();
        };

        // Gestion du modal d'aide
        const helpModal = document.getElementById('helpModal');

        function openHelpModal() {
            helpModal.classList.add('active');
        }

        function closeHelpModal() {
            helpModal.classList.remove('active');
        }

        helpModal.onclick = (e) => {
            if (e.target === helpModal) closeHelpModal();
        };

        // Gestion du modal de configuration Notion
        const notionConfigModal = document.getElementById('notionConfigModal');

        function openNotionConfig() {
            closeHelpModal();
            if (NOTION_TOKEN) document.getElementById('notionToken').value = NOTION_TOKEN;
            if (DATABASE_ID) document.getElementById('databaseId').value = DATABASE_ID;
            if (STORAGE_MODE === 'notion') {
                document.getElementById('disconnectBtn').style.display = 'block';
            }
            notionConfigModal.classList.add('active');
        }

        function closeNotionConfig() {
            notionConfigModal.classList.remove('active');
        }

        async function testNotionConnection() {
            const token = document.getElementById('notionToken').value;
            const dbId = document.getElementById('databaseId').value;
            const statusEl = document.getElementById('notionStatus');

            if (!token || !dbId) {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(90, 74, 74, 0.3)';
                statusEl.style.border = '1px solid #6a5a5a';
                statusEl.style.color = '#9a7a7a';
                statusEl.textContent = '‚ùå Veuillez remplir tous les champs';
                return;
            }

            statusEl.style.display = 'block';
            statusEl.style.background = 'rgba(90, 90, 74, 0.3)';
            statusEl.style.border = '1px solid #6a6a5a';
            statusEl.style.color = '#9a9a7a';
            statusEl.textContent = '‚è≥ Test de connexion en cours...';

            NOTION_TOKEN = token;
            DATABASE_ID = dbId;

            try {
                const response = await notionFetch(
                    `https://api.notion.com/v1/databases/${DATABASE_ID}/query`,
                    { method: 'POST', body: JSON.stringify({}) }
                );

                if (response.ok) {
                    statusEl.style.background = 'rgba(74, 90, 74, 0.3)';
                    statusEl.style.border = '1px solid #5a6a5a';
                    statusEl.style.color = '#7a9a7a';
                    statusEl.textContent = '‚úì Connexion r√©ussie ! Sauvegarde...';

                    localStorage.setItem('notionToken', NOTION_TOKEN);
                    localStorage.setItem('databaseId', DATABASE_ID);
                    localStorage.setItem('storageMode', 'notion');
                    STORAGE_MODE = 'notion';

                    // Migrer les donn√©es locales vers Notion si n√©cessaire
                    const localBooks = localStorage.getItem('libraryBooks');
                    if (localBooks && confirm('Voulez-vous transf√©rer vos livres locaux vers Notion ?')) {
                        const books = JSON.parse(localBooks);
                        for (const book of books) {
                            await createBookInNotion(book);
                        }
                    }

                    setTimeout(() => {
                        closeNotionConfig();
                        loadBooks();
                    }, 1500);
                } else {
                    throw new Error('Connexion √©chou√©e');
                }
            } catch (error) {
                statusEl.style.background = 'rgba(90, 74, 74, 0.3)';
                statusEl.style.border = '1px solid #6a5a5a';
                statusEl.style.color = '#9a7a7a';
                statusEl.textContent = `‚ùå Erreur : ${error.message}. V√©rifiez vos identifiants.`;
            }
        }

        function disconnectNotion() {
            if (confirm('Voulez-vous d√©connecter Notion et revenir au mode local ?')) {
                localStorage.removeItem('notionToken');
                localStorage.removeItem('databaseId');
                localStorage.setItem('storageMode', 'local');
                STORAGE_MODE = 'local';
                NOTION_TOKEN = '';
                DATABASE_ID = '';
                stopNotionAutoRefresh();
                closeNotionConfig();
                loadBooks();
            }
        }

        function updateModeDisplay() {
            const modeEl = document.getElementById('currentMode');
            if (modeEl) {
                if (STORAGE_MODE === 'notion') {
                    modeEl.textContent = 'Notion (synchronis√©)';
                    modeEl.style.color = '#7a9a7a';
                    startNotionAutoRefresh();
                } else {
                    modeEl.textContent = 'Local (navigateur)';
                    modeEl.style.color = '#9a9a7a';
                    stopNotionAutoRefresh();
                }
            }
        }

        notionConfigModal.onclick = (e) => {
            if (e.target === notionConfigModal) closeNotionConfig();
        };

        // Export/Import/Reset
        function exportData() {
            const dataStr = JSON.stringify(BOOKS_CONFIG, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'bibliotheque-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedData = JSON.parse(event.target.result);
                            if (Array.isArray(importedData)) {
                                BOOKS_CONFIG = importedData;
                                saveBooksConfig();
                                generateLibrary();
                                alert('‚úì Donn√©es import√©es avec succ√®s !');
                            } else {
                                alert('‚ùå Format de fichier invalide');
                            }
                        } catch (error) {
                            alert('‚ùå Erreur : ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function resetData() {
            if (confirm('Voulez-vous vraiment r√©initialiser la biblioth√®que ? Toutes vos modifications seront perdues.')) {
                if (STORAGE_MODE === 'notion') {
                    alert('‚ö†Ô∏è En mode Notion, utilisez directement votre database Notion pour supprimer les livres, ou d√©connectez-vous pour r√©initialiser localement.');
                    return;
                }
                localStorage.removeItem('libraryBooks');
                BOOKS_CONFIG = getDefaultBooks();
                saveBooksToLocal();
                generateLibrary();
                alert('‚úì Biblioth√®que r√©initialis√©e !');
            }
        }

        // Initialisation au chargement
        loadBooks();
        updateModeDisplay();
    </script>
</body>
</html>
